# 弹性网络

弹性网络包括

- 限流

  限制流量，比如限制http/tcp连接数、多余的连接数直接返回503，避免太高的并发对系统造成负担。

- 熔断

  流量/异常 等原因直接让线路断开一段时间，一个典型的现象就是使http全部连接都变成503了，等待一段时间后恢复。

  

  限流和熔断的区别：

  限流就好比电路里面的稳流器，能使电流稳定在多少以内。熔断就是可恢复保险丝，电流太大了直接断开，电流小了恢复。这2者经常会一起使用。

在istio 里面包含 连接池（ConnectionPool）限流和异常检测（outlierDetection）熔断。

## 初始化

#### 安装测试服务端

```text
kubectl apply -f samples/httpbin/httpbin.yaml
```

#### 安装测试试客户端

```
kubectl apply -f samples/httpbin/sample-client/fortio-deploy.yaml
```

## 限流

#### 配置限流

```text
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: httpbin
spec:
  host: httpbin
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 1
      http:
        http1MaxPendingRequests: 1
        maxRequestsPerConnection: 1
EOF
```

使用2个线程，测试20个http请求

```
kubectl exec -it $FORTIO_POD  -c fortio /usr/bin/fortio -- load -c 2 -qps 0 -n 20 -loglevel Warning http://httpbin:8000/get
08:19:17 I logger.go:97> Log level is now 3 Warning (was 2 Info)
Fortio 1.3.1 running at 0 queries per second, 4->4 procs, for 20 calls: http://httpbin:8000/get
Starting at max qps with 2 thread(s) [gomax 4] for exactly 20 calls (10 per thread + 0)
08:19:17 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
08:19:17 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
08:19:17 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
08:19:17 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
Ended after 58.17069ms : 20 calls. qps=343.82
Aggregated Function Time : count 20 avg 0.0051901683 +/- 0.002815 min 0.000350377 max 0.012165004 sum 0.103803366
# range, mid point, percentile, count
>= 0.000350377 <= 0.001 , 0.000675189 , 10.00, 2
> 0.001 <= 0.002 , 0.0015 , 15.00, 1
> 0.002 <= 0.003 , 0.0025 , 20.00, 1
> 0.003 <= 0.004 , 0.0035 , 35.00, 3
> 0.004 <= 0.005 , 0.0045 , 50.00, 3
> 0.005 <= 0.006 , 0.0055 , 65.00, 3
> 0.006 <= 0.007 , 0.0065 , 75.00, 2
> 0.007 <= 0.008 , 0.0075 , 85.00, 2
> 0.008 <= 0.009 , 0.0085 , 95.00, 2
> 0.012 <= 0.012165 , 0.0120825 , 100.00, 1
# target 50% 0.005
# target 75% 0.007
# target 90% 0.0085
# target 99% 0.012132
# target 99.9% 0.0121617
Sockets used: 6 (for perfect keepalive, would be 2)
Code 200 : 16 (80.0 %)
Code 503 : 4 (20.0 %)
Response Header Sizes : count 20 avg 184 +/- 92 min 0 max 230 sum 3680
Response Body/Total Sizes : count 20 avg 705.8 +/- 232.4 min 241 max 822 sum 14116
All done 20 calls (plus 0 warmup) 5.190 ms avg, 343.8 qps
```

将线程增加到3个进行测试

```
kubectl exec -it $FORTIO_POD  -c fortio /usr/bin/fortio -- load -c 3 -qps 0 -n 20 -loglevel Warning http://httpbin:8000/get
08:24:25 I logger.go:97> Log level is now 3 Warning (was 2 Info)
Fortio 1.3.1 running at 0 queries per second, 4->4 procs, for 20 calls: http://httpbin:8000/get
Starting at max qps with 3 thread(s) [gomax 4] for exactly 20 calls (6 per thread + 2)
08:24:25 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
08:24:25 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
08:24:25 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
08:24:25 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
08:24:25 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
08:24:25 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
08:24:25 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
08:24:25 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
08:24:25 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
08:24:25 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
08:24:25 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
08:24:25 W http_client.go:679> Parsed non ok code 503 (HTTP/1.1 503)
Ended after 28.898017ms : 20 calls. qps=692.09
Aggregated Function Time : count 20 avg 0.0024862615 +/- 0.002396 min 0.0003322 max 0.008713829 sum 0.04972523
# range, mid point, percentile, count
>= 0.0003322 <= 0.001 , 0.0006661 , 40.00, 8
> 0.001 <= 0.002 , 0.0015 , 60.00, 4
> 0.003 <= 0.004 , 0.0035 , 80.00, 4
> 0.004 <= 0.005 , 0.0045 , 85.00, 1
> 0.005 <= 0.006 , 0.0055 , 90.00, 1
> 0.007 <= 0.008 , 0.0075 , 95.00, 1
> 0.008 <= 0.00871383 , 0.00835691 , 100.00, 1
# target 50% 0.0015
# target 75% 0.00375
# target 90% 0.006
# target 99% 0.00857106
# target 99.9% 0.00869955
Sockets used: 13 (for perfect keepalive, would be 3)
Code 200 : 8 (40.0 %)
Code 503 : 12 (60.0 %)
Response Header Sizes : count 20 avg 92 +/- 112.7 min 0 max 230 sum 1840
Response Body/Total Sizes : count 20 avg 473.4 +/- 284.6 min 241 max 822 sum 9468
All done 20 calls (plus 0 warmup) 2.486 ms avg, 692.1 qps
```

可以发现503的结果变多了

#### 限流配置

ConnectionPool可以对上游服务的并发连接数和请求数进行限制，适用于TCP和HTTP。ConnectionPool又称之是限流。

- tcp限流
  - maxConnections 最大连接数
  - connectTimeout 超时
  - tcpKeepalive 如果在套接字上设置SO_KEEPALIVE可以确保TCP 存活
    - Probes：在确定连接已死之前，在没有响应的情况下发送的keepalive探测的最大数量。默认值是使用系统级别的配置(除非写词参数覆盖，Linux默认值为9)。
    - Time：发送keep-alive探测前连接存在的空闲时间。默认值是使用系统的配置(除非写此参数，Linux默认值为7200s(即2小时)。
    - interval：探测活动之间的时间间隔。默认值是使用系统的配置(除非被覆盖，Linux默认值为75秒)。
- http限流
  - http1MaxPendingRequests http请求pending状态的最大请求数，从应用容器发来的HTTP请求的最大等待转发数，默认是1024
  - http2MaxRequests：后端请求的最大数量，默认是1024
  - maxRequestsPerConnection：在一定时间内限制对后端服务发起的最大请求数，如果超过了这个限制，就会开启限流。如果将这一参数设置为 1 则会禁止 keepalive 特性
  - idleTimeout：上游连接池连接的空闲超时
  - maxRetries：在给定时间内，集群中所有主机都可以执行的最大重试次数



## 熔断

#### 异常(熔断)配置

outlierDetection针对异常情况进行配置

- consecutiveErrors 失败的次数。对于HTTP服务，502、503、504会被认为异常，TPC服务，连接超时即异常
- Interval 驱逐的时间间隔，默认是10秒
- baseEjectionTime 最小驱逐时间。驱逐时间会随着错误次数增加而增加。即错误次数*最小驱逐时间
- maxEjectionPercent 负载均衡池中可以被驱逐的实例的最大比例。以免某个接口瞬时不可用，导致太多实例被驱逐，进而导致服务整体全部不可用。
- minHealthPercent 有最小健康百分比的阈值

该配置表示每秒钟扫描一次上游主机，连续失败1 次返回 5xx 错误码的所有主机会被移出连接池 3 分钟
