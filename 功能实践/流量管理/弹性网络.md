# 弹性网络

弹性网络包括

- 限流
- 连接熔断

## 熔断

熔断的目的是当A服务模块中的某块程序出现故障后为了不影响其他客户端的请求而做出的及时回应。

#### 安装测试服务端

```text
kubectl apply -f samples/httpbin/httpbin.yaml
```

#### 配置熔断器

```text
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: httpbin
spec:
  host: httpbin
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 1
      http:
        http1MaxPendingRequests: 1
        maxRequestsPerConnection: 1
    outlierDetection:
      consecutiveErrors: 1
      interval: 1s
      baseEjectionTime: 3m
      maxEjectionPercent: 100
EOF
```

#### 限流配置

ConnectionPool可以对上游服务的并发连接数和请求数进行限制，适用于TCP和HTTP。ConnectionPool又称之是限流。

- tcp限流
  - maxConnections 最大连接数
  - connectTimeout 超时
  - tcpKeepalive 如果在套接字上设置SO_KEEPALIVE可以确保TCP 存活
    - Probes：在确定连接已死之前，在没有响应的情况下发送的keepalive探测的最大数量。默认值是使用系统级别的配置(除非写词参数覆盖，Linux默认值为9)。
    - Time：发送keep-alive探测前连接存在的空闲时间。默认值是使用系统的配置(除非写此参数，Linux默认值为7200s(即2小时)。
    - interval：探测活动之间的时间间隔。默认值是使用系统的配置(除非被覆盖，Linux默认值为75秒)。
- http限流
  - http1MaxPendingRequests http请求pending状态的最大请求数，从应用容器发来的HTTP请求的最大等待转发数，默认是1024
  - http2MaxRequests：后端请求的最大数量，默认是1024
  - maxRequestsPerConnection：在一定时间内限制对后端服务发起的最大请求数，如果超过了这个限制，就会开启限流。如果将这一参数设置为 1 则会禁止 keepalive 特性
  - idleTimeout：上游连接池连接的空闲超时
  - maxRetries：在给定时间内，集群中所有主机都可以执行的最大重试次数

#### 异常配置

outlierDetection针对异常情况进行配置

- consecutiveErrors 失败的次数
- Interval 拒绝访问检测的时间
- baseEjectionTime 最短拒绝访问时间
- maxEjectionPercent 移除百分比
- minHealthPercent 有最小健康百分比的阈值

该配置表示每秒钟扫描一次上游主机，连续失败1 次返回 5xx 错误码的所有主机会被移出连接池 3 分钟
![img](../../../../../../media/15899625726559/15903904132508.jpg)￼